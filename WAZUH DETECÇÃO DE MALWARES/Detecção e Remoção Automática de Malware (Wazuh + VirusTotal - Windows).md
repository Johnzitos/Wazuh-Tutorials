
<h1 align="center">Detecção e Remoção Automática de Malware (Wazuh + VirusTotal - Windows)</h1>

<p <p align="center">
   <img width="2752" height="1363" alt="wallpaper virus total(Editado)" src="https://github.com/user-attachments/assets/e60545a7-dad2-49d3-9cf1-cd537ba4baa5" width="90%"/>
</p>

<div align="center">

<img src="https://img.shields.io/badge/Target-Windows%2010-blue" alt="Windows Badge">
<img src="https://img.shields.io/badge/Integration-VirusTotal-red" alt="VirusTotal Badge">
<img src="https://img.shields.io/badge/Action-Auto%20Delete-red" alt="Action Badge">

</div>

---

## Contexto

Apenas detectar um vírus não é suficiente se a resposta demorar. Em cenários de ataque rápido, a **automatização** é essencial.

Este projeto configura o **Wazuh** para monitorar uma pasta crítica no **Windows 10**. Novos arquivos têm seus hashes enviados automaticamente para a API do **VirusTotal**. Caso o arquivo seja identificado como malicioso, o Wazuh aciona uma **Resposta Ativa** que executa a deleção imediata do artefato.

---

## Pré-requisitos

* **Wazuh Manager** (Linux) e **Wazuh Agent** (Windows 10) instalados e conectados
* **Acesso à Internet**

  * O servidor deve acessar **`www.virustotal.com` (porta 443)**
* **Python 3** instalado no Windows 10 (**adicionado ao PATH**)
* **API Key do VirusTotal**

---

## 1. Configuração do Monitoramento (Windows Agent)

Edite o arquivo:

**`C:\Program Files (x86)\ossec-agent\ossec.conf`**

Dentro do bloco `<syscheck>`, configure o monitoramento em tempo real:

```xml
<syscheck>
  <disabled>no</disabled>
  <frequency>300</frequency>
  <scan_on_start>yes</scan_on_start>

  <directories check_all="yes" realtime="yes">
    C:\Users\SEU_USUARIO\Downloads
  </directories>

  <ignore type="sregex">.log$|.tmp$</ignore>
</syscheck>
```

Reinicie o serviço do agente:

```powershell
Restart-Service -Name WazuhSvc
```

---

## 2. Configuração da Integração (Wazuh Manager)

No arquivo:

**`/var/ossec/etc/ossec.conf`**

Adicione a integração com o **VirusTotal**, incluindo os IDs de regra do **FIM (554)** e **Sysmon (92203)**:

```xml
<integration>
  <name>virustotal</name>
  <api_key>SUA_API_KEY_AQUI</api_key>
  <rule_id>554,92203</rule_id>
  <level>0</level>
  <alert_format>json</alert_format>
</integration>
```

---

## 3. Script de Remoção (Windows)

### 3.1 Script Python

Crie o arquivo:

**`C:\Program Files (x86)\ossec-agent\active-response\bin\remove-threat.py`**

```python
#!/usr/bin/env python3
import sys
import json
import os
import datetime

LOG_FILE = "C:\\Program Files (x86)\\ossec-agent\\active-response\\active-responses.log"

def write_log(msg):
    timestamp = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    with open(LOG_FILE, "a") as f:
        f.write(f"{timestamp} - {msg}\n")

try:
    input_data = sys.stdin.read()
    alert_data = json.loads(input_data)

    filename = alert_data.get('parameters', {}).get('alert', {}).get('data', {}).get('virustotal', {}).get('source', {}).get('file')
    if not filename:
        filename = alert_data.get('parameters', {}).get('alert', {}).get('syscheck', {}).get('path')

    if os.path.exists(filename):
        os.remove(filename)
        write_log(f"SUCCESS: File removed: {filename}")
        print(json.dumps({"error": 0, "message": "Threat Removed"}))
    else:
        write_log(f"ERROR: File not found: {filename}")

except Exception as e:
    write_log(f"CRITICAL: {str(e)}")
```

---

### 3.2 Lançador Batch

Crie o arquivo:

**`remove-threat.cmd`**

> ⚠️ Ajuste o caminho do **Python** conforme sua instalação.

```batch
@echo off
"C:\Users\SEU_USUARIO\AppData\Local\Programs\Python\Python311\python.exe" ^
"C:\Program Files (x86)\ossec-agent\active-response\bin\remove-threat.py"
```

---

## 4. Ativar a Resposta Ativa (Wazuh Manager)

No arquivo:

**`/var/ossec/etc/ossec.conf`**

Associe o comando à regra **87105 (VirusTotal – Malicious)**:

```xml
<command>
  <name>win-remove-threat</name>
  <executable>remove-threat.cmd</executable>
  <timeout_allowed>no</timeout_allowed>
</command>

<active-response>
  <command>win-remove-threat</command>
  <location>local</location>
  <rules_id>87105</rules_id>
</active-response>
```

Reinicie o Wazuh Manager:

```bash
systemctl restart wazuh-manager
```

---

## 5. Troubleshooting e Validação

### Correção de Permissões (Linux)

Caso apareça **`Permission denied`** no arquivo **`ossec.log`**:

```bash
systemctl stop wazuh-manager
rm -f /var/ossec/etc/shared/default/merged.mg
chown -R wazuh:wazuh /var/ossec
chmod 770 /var/ossec/etc/shared/default
systemctl start wazuh-manager
```

---

### Teste de Execução (EICAR)

No **Windows (PowerShell)**, crie um arquivo de teste EICAR:

```powershell
Set-Content -Path "C:\Users\SEU_USUARIO\Downloads\teste_virus.com" `
-Value 'X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*'
```

> ✅ O arquivo deverá ser **removido automaticamente em segundos**.

---

## Próximos Passos

Após validar o funcionamento básico, considere evoluir a solução:

1. **Whitelist**
   Implementar verificação de diretórios confiáveis ou assinaturas digitais para evitar falsos positivos.

2. **Dashboards Personalizados**
   Criar visualizações no **Kibana/OpenSearch** para acompanhar ameaças neutralizadas por endpoint.

3. **Notificações**
   Enviar alertas via **E-mail, Slack ou Discord** sempre que a Resposta Ativa for acionada.

4. **Isolamento de Host**
   Evoluir o script para **isolar a máquina da rede** em ameaças críticas (ex: ransomware).

---


