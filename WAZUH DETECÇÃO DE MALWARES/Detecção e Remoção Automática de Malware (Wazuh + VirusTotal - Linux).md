<h1 align="center">Detecção e Remoção Automática de Malware (Wazuh + VirusTotal - Linux)</h1>

<p align="center">
<img width="2752" height="1366" alt="wallpaper virus total linux" src="https://github.com/user-attachments/assets/b369d47d-0bf7-4c58-8e25-4d11a1abad21" width="90%"/>
</p>
<div align="center">

  <img src="https://img.shields.io/badge/Target-Ubuntu%20%2F%20Linux-orange" alt="Linux Badge">
  <img src="https://img.shields.io/badge/Integration-VirusTotal-red" alt="VirusTotal Badge">
  <img src="https://img.shields.io/badge/Action-Auto%20Delete-red" alt="Action Badge">

</div>

---

## Contexto

Apenas detectar um vírus não é suficiente se a resposta demorar. Em cenários de ataque rápido, a **automatização** é essencial.

Este projeto configura o **Wazuh** para monitorar a pasta de Downloads em estações **Ubuntu/Linux**. Novos arquivos têm seus hashes enviados automaticamente para a API do **VirusTotal**. Caso o arquivo seja identificado como malicioso, o Wazuh aciona uma **Resposta Ativa** que executa a deleção imediata do artefato.

---

## Pré-requisitos

* **Wazuh Manager** e **Wazuh Agent** (Linux) instalados e conectados
* **Acesso à Internet**
* O servidor deve acessar **`www.virustotal.com` (porta 443)**


* **Pacote `jq**` instalado no Agente (processador de JSON)
* **API Key do VirusTotal**

---

## 1. Configuração do Monitoramento (Linux Agent)

Edite o arquivo no agente (ou via configuração centralizada):

**`/var/ossec/etc/ossec.conf`**

Dentro do bloco `<syscheck>`, configure o monitoramento em tempo real para a pasta de Downloads (o `*` abrange todos os usuários):

```xml
<syscheck>
  <disabled>no</disabled>
  <frequency>300</frequency>
  <scan_on_start>yes</scan_on_start>

  <directories check_all="yes" realtime="yes">
    /home/*/Downloads
  </directories>

  <ignore type="sregex">.log$|.tmp$</ignore>
</syscheck>

```

Reinicie o serviço do agente:

```bash
systemctl restart wazuh-agent

```

---

## 2. Configuração da Integração (Wazuh Manager)

No servidor Manager, edite o arquivo:

**`/var/ossec/etc/ossec.conf`**

Adicione a integração com o **VirusTotal**, vinculando ao grupo `syscheck`:

```xml
<integration>
  <name>virustotal</name>
  <api_key>SUA_API_KEY_AQUI</api_key>
  <group>syscheck</group>
  <alert_format>json</alert_format>
</integration>

```

---

## 3. Script de Remoção (Linux Agent)

### 3.1 Instalar Dependência

No agente Ubuntu, instale o processador de JSON necessário para o script:

```bash
sudo apt update && sudo apt install jq -y

```

### 3.2 Criar o Script Bash

Crie o arquivo:

**`/var/ossec/active-response/bin/remove-threat.sh`**

```bash
#!/bin/bash

LOCAL=$(dirname $0);
cd $LOCAL
cd ../

PWD=$(pwd)

read INPUT_JSON
FILENAME=$(echo $INPUT_JSON | jq -r .parameters.alert.data.virustotal.source.file)
COMMAND=$(echo $INPUT_JSON | jq -r .command)

LOG_FILE="${PWD}/../logs/active-responses.log"

# Verifica comando
if [ "${COMMAND}" = "add" ]; then
 :
else
 echo "`date '+%Y/%m/%d %H:%M:%S'` $0: $INPUT_JSON Active response aborted" >> ${LOG_FILE}
 exit 0;
fi

# Remove o arquivo
if [ -f "$FILENAME" ]; then
    rm -f "$FILENAME"
    if [ $? -eq 0 ]; then
        echo "`date '+%Y/%m/%d %H:%M:%S'` $0: $INPUT_JSON Successfully removed threat" >> ${LOG_FILE}
    else
        echo "`date '+%Y/%m/%d %H:%M:%S'` $0: $INPUT_JSON Error removing threat" >> ${LOG_FILE}
    fi
else
    echo "`date '+%Y/%m/%d %H:%M:%S'` $0: $INPUT_JSON File not found" >> ${LOG_FILE}
fi

```

### 3.3 Permissões de Execução

É crucial ajustar as permissões para o usuário `wazuh` e `root`:

```bash
chmod 750 /var/ossec/active-response/bin/remove-threat.sh
chown root:wazuh /var/ossec/active-response/bin/remove-threat.sh

```

---

## 4. Ativar a Resposta Ativa (Wazuh Manager)

No arquivo **`/var/ossec/etc/ossec.conf`** do Manager:

Associe o script à regra **87105 (VirusTotal – Malicious)**:

```xml
<command>
  <name>remove-threat-linux</name>
  <executable>remove-threat.sh</executable>
  <timeout_allowed>no</timeout_allowed>
</command>

<active-response>
  <command>remove-threat-linux</command>
  <location>local</location>
  <rules_id>87105</rules_id>
</active-response>

```

Reinicie o Wazuh Manager:

```bash
systemctl restart wazuh-manager

```

---

## 5. Troubleshooting e Validação

### Verificar Logs de Resposta

Para acompanhar a execução em tempo real no agente:

```bash
tail -f /var/ossec/logs/active-responses.log

```

---

### Teste de Execução (EICAR)

No terminal do **Ubuntu (Agente)**, baixe o arquivo de teste na pasta monitorada:

```bash
cd ~/Downloads
curl -o jogo_falso.exe https://secure.eicar.org/eicar.com

```

> ✅ O arquivo deverá ser **removido automaticamente em segundos** e uma entrada aparecerá no log.
<p align="center">
<img width="1050" height="59" alt="image" src="https://github.com/user-attachments/assets/517e17a4-2b5f-4ff2-93ad-8fdd6a5b1d55" width="90%" />
</p>

---

## Próximos Passos

Após validar o funcionamento básico, considere evoluir a solução:

1. **Whitelist**
Implementar verificação de diretórios confiáveis para evitar falsos positivos em atualizações do sistema.
2. **Dashboards Personalizados**
Criar visualizações no **Kibana/OpenSearch** filtrando pelo ID de regra 87105.
3. **Notificações**
Enviar alertas via **Slack, Discord ou Telegram** sempre que o script `remove-threat-linux` for acionado.
4. **Isolamento de Host**
Evoluir o script para bloquear a rede via `iptables` em caso de ameaças críticas.

---
